<!--todo: 
emoji
handle message delete
slash command /
button interactions
render embed
mark message unread / read-->
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- load MUI -->
        <link href="./libs/mui.min.css" rel="stylesheet" type="text/css" />
        <script src="./libs/mui.min.js"></script>
        <link href="./libs/no.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    </head>
    <body>
        <script>
            window.onload = async function(){
                function getMeta(url, callback) {
                    const img = new Image();
                    img.src = url;
                    img.onload = function() { callback(this.width, this.height); }
                }
                var log = {
                    text: function(text, type=0){
                    var a = document.createElement("p")
                    a.innerText = text;
                    if(type==0){
                    document.getElementById("chat").appendChild(a)
                    } else {
                    document.getElementById("chat").prepend(a)
                    }
                    },
                    image: function(src, type=0){
                        var a = document.createElement("img")
                        a.src = src;
                        if(getMeta(src, (e,t)=>{if(e==t){return true}else{return false}})){
                        a.style.width = "300px";
                        a.style.height = "300px";
                        } else if(getMeta(src, (e,t)=>{if(e<t){return true}else{return false}})){
                            a.style.width = "300px";
                            a.style.height = "180px";
                        } else {
                            a.style.width = "400px";
                            a.style.height = "225px";
                        }
                        if(type==0){
                            document.getElementById("chat").appendChild(a)
                        } else {
                            document.getElementById("chat").prepend(a)
                        }
                    },
                    video: function(src, type=0){
                        var a = document.createElement("video")
                        a.src = src;
                        a.controls = true;
                        if(getMeta(src, (e,t)=>{if(e==t){return true}else{return false}})){
                            a.style.width = "300px";
                            a.style.height = "300px";
                            } else if(getMeta(src, (e,t)=>{if(e<t){return true}else{return false}})){
                                a.style.width = "300px";
                                a.style.height = "180px";
                            } else {
                                a.style.width = "400px";
                                a.style.height = "225px";
                            }
                            if(type==0){
                                document.getElementById("chat").appendChild(a)
                            } else {
                                document.getElementById("chat").prepend(a)
                            }
                    },
                    file: function(src, text, type=0, download=false){
                        var a = document.createElement("a")
                        a.href = src;
                        a.download = download;
                        a.innerText = text;
                        a.target = "_blank"
                        if(type==0){
                            document.getElementById("chat").appendChild(a)
                        } else{
                            document.getElementById("chat").prepend(a)
                        }
                    }
                }
                var Client = {
                    clientIds: [],
                    clientName: {},
                    intervalIds: {},
                    reconnectAttempts: 0,
                    start: function(clientName, token, channelid){
                        if(Client.clientIds.length > 0){
                            for(i of Client.clientIds) {
                                Client.close(i)
                            }
                        }
                    Client.clientIds.push(clientName)
                    Client.clientName[clientName] = new WebSocket("wss://gateway.discord.gg/?v=6&encoding=json")
                    var interval = 0;
                    var payload = {
                        op:2,
                        d: {
                            token: token,
                            properties: {
                                $os: "windows",
                                $browser: 'chrome',
                                $device: "pc"
                            }
                        }
                    }
                    Client.clientName[clientName].onopen = function open() {
                        Client.reconnectAttempts = 0
                        Client.clientName[clientName].send(JSON.stringify(payload))
                    }
                    Client.clientName[clientName].onclose = function close() {
                        console.log("Reconnecting client...")
                        clearInterval(Client.intervalIds[clientName])
                        delete Client.clientName[clientName]
                        Client.clientIds.splice(Client.clientIds.indexOf(clientName), 1)
                        delete Client.intervalIds[clientName]
                        Client.reconnectAttempts += 1
                        if(Client.reconnectAttempts>=5){
                            console.log("Reconnect failed!")
                        } else{
                        window.setTimeout(function() {
                            Client.start(clientName, token, channelid, true)
                        }, 10)
                    }
                    }
                    Client.clientName[clientName].onmessage = function incoming(data){
                        var payload = JSON.parse(data.data)
                        const {t, s, op, d} = payload;
                        
                        switch (op) {
                            case 10:
                                const {heartbeat_interval} = d;
                                interval = heartbeat(heartbeat_interval)
                                break
                        }
                        switch (t) {
                            case 'MESSAGE_CREATE':
                                let author = d.author.username
                                let content = d.content
                                if (channelid.toLowerCase() != 'all'){
                                    if (d.channel_id === channelid) {
                                        log.text(`${author}#${d.author.discriminator}: ${content}`)
                                        if(d.attachments.length > 0){
                                            for(i of d.attachments){
                                                if(i.content_type.includes("image")){
                                                    log.image(i.url)
                                                } else if(i.content_type.includes("video")) {
                                                    log.video(i.url)
                                                } else {
                                                    log.file(i.url, i.filename)
                                                }
                                            }
                                        }
                                    }
                                } else {
                                    log.text(`${author}#${d.author.discriminator}: ${content}`)
                                    if(d.attachments.length > 0){
                                        for(i of d.attachments){
                                            if(i.content_type.includes("image")){
                                                log.image(i.url)
                                            } else if(i.content_type.includes("video")) {
                                                log.video(i.url)
                                            } else {
                                                log.file(i.url, i.filename)
                                            }
                                        }
                                    }
                                }
                        }
                    }
                    
                    const heartbeat = (ms) => {
                        Client.intervalIds[clientName] = setInterval(()=>{
                            Client.clientName[clientName].send(JSON.stringify({op:1, d: null}))
                        }, ms)
                        return Client.intervalIds[clientName]
                    }
                    },
                    close: function(clientName) {
                        for(i in Client.clientIds){
                            if(clientName==Client.clientIds[i]){
                                console.log(Client)
                                Client.clientName[clientName].onclose = function(){}
                                Client.clientName[clientName].close()
                                clearInterval(Client.intervalIds[clientName])
                                delete Client.clientName[clientName]
                                Client.clientIds.splice(Client.clientIds.indexOf(clientName), 1)
                                delete Client.intervalIds[clientName]
                                break
                            } else{
                                console.warn("Unknown Client Id!")
                                break
                            }
                        }
                    }
                    }
function sendMessage(token, channelId, message) {
    return fetch(`https://discord.com/api/v9/channels/${channelId}/messages`, {method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': token, 'Origin': "https://discord.com"}, body: JSON.stringify({content: message})})
}
async function getMessage(token, channelId, limit=50) {
    var messages = await fetch(`https://discord.com/api/v9/channels/${channelId}/messages?limit=${limit}`, {headers: {'Content-Type': 'application/json', 'authorization': token, 'Origin': "https://discord.com"}}).then(res=>res.json())
    for(d of messages) {
        if(d.attachments.length > 0){
            for(i of d.attachments){
                if(i.content_type.includes("image")){
                    log.image(i.url, 1)
                } else if(i.content_type.includes("video")) {
                    log.video(i.url, 1)
                } else {
                    log.file(i.url, i.filename, 1)
                }
            }
        }
        log.text(`${d.author.username}#${d.author.discriminator}: ${d.content}`, 1)
    }
}
document.getElementById("start").onclick = async function(){
    var token = document.getElementById("token").value
    var channelId = document.getElementById("channelid").value
    document.getElementById("chat").innerHTML = ``
    if (token.includes("Bot ")){
        document.getElementById("chatbox").disabled = true
        document.getElementById("send").disabled = true
    } else {
        try {await getMessage(token, channelId)} catch { }
        document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight-document.getElementById("chat").clientHeight
    }
    Client.start(Math.random(), token, channelId)
    document.getElementById("send").disabled = false
    document.getElementById("chatbox").disabled = false
}
document.getElementById("send").onclick = function(){
    var message = document.getElementById("chatbox").value
    var token = document.getElementById("token").value
    var channelId = document.getElementById("channelid").value
    if (!token.includes("Bot ")){
    sendMessage(token, channelId, message).then(function(){document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight-document.getElementById("chat").clientHeight})
    document.getElementById("chatbox").value = ""
    }
}
window.onkeydown = function(e){
    if(e.keyCode == 13){
        document.getElementById("send").click();
    }
}
}
        </script>
        <div class="input-box">
        <div id="form1">
            <div class="input-form">
            <input id="token" type="password" required>
            <div class="underline"></div>
            <label>Token</label>
            </div><br>
            <div class="input-form">
            <input id="channelid" type="text" required>
            <div class="underline"></div>
            <label>Channel Id</label>
            </div><br>
        </div><!--860px;400px-->
        <div class="input-box chat-ui" id="chat"></div><br><br>
        <div id="form2">
            <div class="input-form">
            <input id="chatbox" type="text" required disabled>
            <div class="underline"></div>
            <label>Message</label>
            </div>
            <button class="mui-btn mui-btn--danger" id="start">Start Client</button>
            <button class="mui-btn mui-btn--primary" id="send" disabled>Send</button><br>
        </div>
        </div>
    </body>
</html>
