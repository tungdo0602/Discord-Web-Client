<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <script>
            window.onload = async function(){
                var style = document.createElement('style');
                style.innerText = `/* width */
                ::-webkit-scrollbar {
                  width: 10px;
                }
                
                /* Track */
                ::-webkit-scrollbar-track {
                  background: #f1f1f1; 
                }
                 
                /* Handle */
                ::-webkit-scrollbar-thumb {
                  background: #888; 
                }
                
                /* Handle on hover */
                ::-webkit-scrollbar-thumb:hover {
                  background: #555; 
                }`
                document.getElementById("chat").contentDocument.head.appendChild(style)
                function log(text, type=0){
                    var a = document.createElement("p")
                    a.innerText = text;
                    if(type==0){
                    return document.getElementById("chat").contentDocument.body.appendChild(a)
                    } else {
                    return document.getElementById("chat").contentDocument.body.prepend(a)
                    }
                }
                var Client = {
                    clientIds: [],
                    clientName: {},
                    intervalIds: {},
                    start: function(clientName, token, channelid){
                    if(Client.clientIds.length != 0){
                        for(i of Client.clientIds) {
                            Client.close(i)
                        }
                    }
                    Client.clientIds.push(clientName)
                    Client.clientName[clientName] = new WebSocket("wss://gateway.discord.gg/?v=6&encoding=json")
                    var interval = 0;
                    var payload = {
                        op:2,
                        d: {
                            token: token,
                            properties: {
                                $os: "windows",
                                $browser: 'chrome',
                                $device: "pc"
                            }
                        }
                    }
                    Client.clientName[clientName].onopen = function open() {
                        Client.clientName[clientName].send(JSON.stringify(payload))
                    }
                    Client.clientName[clientName].onclose = function close() {
                        console.log("Reconnecting client...")
                        clearInterval(Client.intervalIds[clientName])
                        delete Client.clientName[clientName]
                        delete Client.clientIds[clientName]
                        delete Client.intervalIds[clientName]
                        window.setTimeout(function() {
                            Client.start(clientName, token, channelid)
                        }, 100)
                    }
                    Client.clientName[clientName].onmessage = function incoming(data){
                        var payload = JSON.parse(data.data)
                        const {t, s, op, d} = payload;
                        
                        switch (op) {
                            case 10:
                                const {heartbeat_interval} = d;
                                interval = heartbeat(heartbeat_interval)
                                break
                        }
                        switch (t) {
                            case 'MESSAGE_CREATE':
                                let author = d.author.username
                                let content = d.content
                                if (channelid.toLowerCase() != 'all'){
                                    if (d.channel_id === channelid) {
                                        log(`${author}#${d.author.discriminator}: ${content}`)
                                    }
                                } else {
                                    log(`${author}#${d.author.discriminator}: ${content}`)
                                }
                        }
                    }
                    
                    const heartbeat = (ms) => {
                        Client.intervalIds[clientName] = setInterval(()=>{
                            Client.clientName[clientName].send(JSON.stringify({op:1, d: null}))
                        }, ms)
                        return Client.intervalIds[clientName]
                    }
                    },
                    close: function(clientName) {
                        for(i of Client.clientIds){
                            if(clientName==i){
                                Client.clientName[clientName].onclose = function(){}
                                Client.clientName[clientName].close()
                                clearInterval(Client.intervalIds[clientName])
                                delete Client.clientName[clientName]
                                delete Client.clientIds[clientName]
                                delete Client.intervalIds[clientName]
                                break
                            } else{
                                throw new Error("Unknown Client Id!")
                                break
                            }
                        }
                    }
                    }
function sendMessage(token, channelId, message) {
    return fetch(`https://discord.com/api/v9/channels/${channelId}/messages`, {method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': token, 'Origin': "https://discord.com"}, body: JSON.stringify({content: message})})
}
async function getMessage(token, channelId, limit=50) {
    var messages = await fetch(`https://discord.com/api/v9/channels/${channelId}/messages?limit=${limit}`, {headers: {'Content-Type': 'application/json', 'authorization': token, 'Origin': "https://discord.com"}}).then(res=>res.json())
    for(i of messages) {
        log(`${i.author.username}#${i.author.discriminator}: ${i.content}`, 1)
    }
}
document.getElementById("start").onclick = async function(){
    var token = document.getElementById("token").value
    var channelId = document.getElementById("channelid").value
    document.getElementById("chat").contentDocument.body.innerHTML = ``
    if (token.includes("Bot ")){
        document.getElementById("chatbox").disabled = true
        document.getElementById("chatbox").placeholder = `You Can't send message.`
        document.getElementById("send").style.display = "none"
    } else {
        try {await getMessage(token, channelId)} catch { }
    }
    Client.start("test", token, channelId)
    document.getElementById("chat").contentDocument.body.scrollTop = document.getElementById("chat").contentDocument.body.scrollHeight;
}
document.getElementById("send").onclick = function(){
    var message = document.getElementById("chatbox").value
    var token = document.getElementById("token").value
    var channelId = document.getElementById("channelid").value
    if (!token.includes("Bot ")){
    sendMessage(token, channelId, message)
    document.getElementById("chat").contentDocument.body.scrollTop = document.getElementById("chat").contentDocument.body.scrollHeight;
    document.getElementById("chatbox").value = ""
    }
}
window.onkeydown = function(e){
    if(e.keyCode == 13){
        document.getElementById("send").click();
    }
}
}
        </script>
        <div id="form1">
            <label>Token: </label><input id="token" type="password" placeholder="Your discord token."> <label>Channel Id: </label><input id="channelid" type="text" placeholder='"all" for all channels'> <button id="start">Start Client</button><br><br>
        </div>
        <iframe style="resize: both;" id="chat"></iframe>
        <div id="form2">
            <input id="chatbox" type="text" placeholder="Enter message here."><button id="send">Send Message</button>
        </div>
    </body>
</html>
