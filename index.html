<!--todo: 
emoji
handle message delete
slash command /
button interactions
render embed
mark message unread / read-->
<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <script>
            window.onload = async function(){
                var style = document.createElement('style');
                style.innerText = `/* width */
                ::-webkit-scrollbar {
                  width: 10px;
                }
                
                /* Track */
                ::-webkit-scrollbar-track {
                  background: #f1f1f1; 
                }
                 
                /* Handle */
                ::-webkit-scrollbar-thumb {
                  background: #888; 
                }
                
                /* Handle on hover */
                ::-webkit-scrollbar-thumb:hover {
                  background: #555; 
                }`
                document.getElementById("chat").contentDocument.head.appendChild(style)
                function getMeta(url, callback) {
                    const img = new Image();
                    img.src = url;
                    img.onload = function() { callback(this.width, this.height); }
                }
                var log = {
                    text: function(text, type=0){
                    var a = document.createElement("p")
                    a.innerText = text;
                    if(type==0){
                    document.getElementById("chat").contentDocument.body.appendChild(a)
                    } else {
                    document.getElementById("chat").contentDocument.body.prepend(a)
                    }
                    },
                    image: function(src, type=0){
                        var a = document.createElement("img")
                        a.src = src;
                        if(getMeta(src, (e,t)=>{if(e==t){return true}else{return false}})){
                        a.style.width = "300px";
                        a.style.height = "300px";
                        } else if(getMeta(src, (e,t)=>{if(e<t){return true}else{return false}})){
                            a.style.width = "300px";
                            a.style.height = "180px";
                        } else {
                            a.style.width = "400px";
                            a.style.height = "225px";
                        }
                        if(type==0){
                            document.getElementById("chat").contentDocument.body.appendChild(a)
                        } else {
                            document.getElementById("chat").contentDocument.body.prepend(a)
                        }
                        //var b = document.createElement("br")
                        //document.getElementById("chat").contentDocument.body.appendChild(b)
                    },
                    video: function(src, type=0){
                        var a = document.createElement("video")
                        a.src = src;
                        a.controls = true;
                        if(getMeta(src, (e,t)=>{if(e==t){return true}else{return false}})){
                            a.style.width = "300px";
                            a.style.height = "300px";
                            } else if(getMeta(src, (e,t)=>{if(e<t){return true}else{return false}})){
                                a.style.width = "300px";
                                a.style.height = "180px";
                            } else {
                                a.style.width = "400px";
                                a.style.height = "225px";
                            }
                            if(type==0){
                                document.getElementById("chat").contentDocument.body.appendChild(a)
                            } else {
                                document.getElementById("chat").contentDocument.body.prepend(a)
                            }
                            //var b = document.createElement("br")
                            //document.getElementById("chat").contentDocument.body.appendChild(b)
                    },
                    file: function(src, text, type=0, download=false){
                        var a = document.createElement("a")
                        a.href = src;
                        a.download = download;
                        a.innerText = text;
                        a.target = "_blank"
                        if(type==0){
                            document.getElementById("chat").contentDocument.body.appendChild(a)
                        } else{
                            document.getElementById("chat").contentDocument.body.prepend(a)
                        }
                        //var b = document.createElement("br")
                        //document.getElementById("chat").contentDocument.body.appendChild(b)
                    }
                }
                var Client = {
                    clientIds: [],
                    clientName: {},
                    intervalIds: {},
                    reconnectAttempts: 0,
                    start: function(clientName, token, channelid, isRestart=false){
                    if(isRestart==false){
                        if(Client.clientIds.length != 0){
                            for(i of Client.clientIds) {
                                Client.close(i)
                            }
                        }
                    }
                    Client.clientIds.push(clientName)
                    Client.clientName[clientName] = new WebSocket("wss://gateway.discord.gg/?v=6&encoding=json")
                    var interval = 0;
                    var payload = {
                        op:2,
                        d: {
                            token: token,
                            properties: {
                                $os: "windows",
                                $browser: 'chrome',
                                $device: "pc"
                            }
                        }
                    }
                    Client.clientName[clientName].onopen = function open() {
                        Client.reconnectAttempts = 0
                        Client.clientName[clientName].send(JSON.stringify(payload))
                    }
                    Client.clientName[clientName].onclose = function close() {
                        console.log("Reconnecting client...")
                        clearInterval(Client.intervalIds[clientName])
                        delete Client.clientName[clientName]
                        delete Client.clientIds[clientName]
                        delete Client.intervalIds[clientName]
                        Client.reconnectAttempts += 1
                        if(Client.reconnectAttempts>=5){
                            console.log("Reconnect failed!")
                        } else{
                        window.setTimeout(function() {
                            Client.start(clientName, token, channelid, true)
                        }, 10)
                    }
                    }
                    Client.clientName[clientName].onmessage = function incoming(data){
                        var payload = JSON.parse(data.data)
                        const {t, s, op, d} = payload;
                        
                        switch (op) {
                            case 10:
                                const {heartbeat_interval} = d;
                                interval = heartbeat(heartbeat_interval)
                                break
                        }
                        switch (t) {
                            case 'MESSAGE_CREATE':
                                let author = d.author.username
                                let content = d.content
                                if (channelid.toLowerCase() != 'all'){
                                    if (d.channel_id === channelid) {
                                        log.text(`${author}#${d.author.discriminator}: ${content}`)
                                        if(d.attachments.length > 0){
                                            for(i of d.attachments){
                                                if(i.content_type.includes("image")){
                                                    log.image(i.url)
                                                } else if(i.content_type.includes("video")) {
                                                    log.video(i.url)
                                                } else {
                                                    log.file(i.url, i.filename)
                                                }
                                            }
                                        }
                                    }
                                } else {
                                    log.text(`${author}#${d.author.discriminator}: ${content}`)
                                    if(d.attachments.length > 0){
                                        for(i of d.attachments){
                                            if(i.content_type.includes("image")){
                                                log.image(i.url)
                                            } else if(i.content_type.includes("video")) {
                                                log.video(i.url)
                                            } else {
                                                log.file(i.url, i.filename)
                                            }
                                        }
                                    }
                                }
                        }
                    }
                    
                    const heartbeat = (ms) => {
                        Client.intervalIds[clientName] = setInterval(()=>{
                            Client.clientName[clientName].send(JSON.stringify({op:1, d: null}))
                        }, ms)
                        return Client.intervalIds[clientName]
                    }
                    },
                    close: function(clientName) {
                        for(i of Client.clientIds){
                            if(clientName==i){
                                Client.clientName[clientName].onclose = function(){}
                                Client.clientName[clientName].close()
                                clearInterval(Client.intervalIds[clientName])
                                delete Client.clientName[clientName]
                                delete Client.clientIds[clientName]
                                delete Client.intervalIds[clientName]
                                break
                            } else{
                                throw new Error("Unknown Client Id!")
                                break
                            }
                        }
                    }
                    }
function sendMessage(token, channelId, message) {
    return fetch(`https://discord.com/api/v9/channels/${channelId}/messages`, {method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': token, 'Origin': "https://discord.com"}, body: JSON.stringify({content: message})})
}
async function getMessage(token, channelId, limit=50) {
    var res = await fetch(`https://discord.com/api/v9/channels/${channelId}/messages?limit=${limit}`, {headers: {'Content-Type': 'application/json', 'authorization': token, 'Origin': "https://discord.com"}})
    var messages = res.then(res=>res.json())
    for(d of messages) {
        if(d.attachments.length > 0){
            for(i of d.attachments){
                if(i.content_type.includes("image")){
                    log.image(i.url, 1)
                } else if(i.content_type.includes("video")) {
                    log.video(i.url, 1)
                } else {
                    log.file(i.url, i.filename, 1)
                }
            }
        }
        log.text(`${d.author.username}#${d.author.discriminator}: ${d.content}`, 1)
    }
    return res
}
document.getElementById("start").onclick = async function(){
    var token = document.getElementById("token").value
    var channelId = document.getElementById("channelid").value
    document.getElementById("chat").contentDocument.body.innerHTML = ``
    if (token.includes("Bot ")){
        document.getElementById("chatbox").disabled = true
        document.getElementById("chatbox").placeholder = `You Can't send message.`
        document.getElementById("send").style.display = "none"
    } else {
        try {await getMessage(token, channelId).then(document.getElementById("chat").contentDocument.body.scrollTop = document.getElementById("chat").contentDocument.body.scrollHeight-document.getElementById("chat").contentDocument.body.clientHeight)} catch { }
    }
    Client.start("test", token, channelId).then()
}
document.getElementById("send").onclick = function(){
    var message = document.getElementById("chatbox").value
    var token = document.getElementById("token").value
    var channelId = document.getElementById("channelid").value
    if (!token.includes("Bot ")){
    sendMessage(token, channelId, message).then(function(){document.getElementById("chat").contentDocument.body.scrollTop = document.getElementById("chat").contentDocument.body.scrollHeight-document.getElementById("chat").contentDocument.body.clientHeight})
    document.getElementById("chatbox").value = ""
    }
}
window.onkeydown = function(e){
    if(e.keyCode == 13){
        document.getElementById("send").click();
    }
}
}
        </script>
        <div id="form1">
            <label>Token: </label><input id="token" type="password" placeholder="Your discord token."> <label>Channel Id: </label><input id="channelid" type="text" placeholder='"all" for all channels'> <button id="start">Start Client</button><br><br>
        </div>
        <iframe style="resize: both;" id="chat"></iframe>
        <div id="form2">
            <input id="chatbox" type="text" placeholder="Enter message here."><button id="send">Send Message</button>
        </div>
    </body>
</html>
